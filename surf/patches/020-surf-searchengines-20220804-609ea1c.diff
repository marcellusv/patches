From 2f64431f15777d93d146707dccdb6ad063c7a316 Mon Sep 17 00:00:00 2001
From: Justinas Grigas <jstn_as@protonmail.com>
Date: Thu, 4 Aug 2022 23:18:40 +0300
Subject: [PATCH] searchengines: allows simple use of search engines

The previous patches had some issues:
* don't apply cleanly to the latest version.
* a space between the token and query is implied, so having " " as a
  token means you actually have to use "  ". Or if your token is "e",
  searching for "example.com" would trigger it. Now you specify the exact
  token to look for.
* has checks to skip badly configured search engines. The correct
  solution is to configure them right.

Now it works like a better version of the spacesearch patch, as it
allows you to specify " " as a token
---
 config.def.h |  5 +++++
 surf.c       | 22 +++++++++++++++++++++-
 2 files changed, 26 insertions(+), 1 deletion(-)

Index: surf/config.def.h
===================================================================
--- surf.orig/config.def.h
+++ surf/config.def.h
@@ -7,6 +7,11 @@ static char *certdir        = "~/.surf/c
 static char *cachedir       = "~/.surf/cache/";
 static char *cookiefile     = "~/.surf/cookies.txt";
 
+static SearchEngine searchengines[] = {
+	{ " ", "https://duckduckgo.com/?q=%s" },
+	{ "osrs ", "https://oldschool.runescape.wiki/?search=%s" },
+};
+
 /* Webkit default features */
 /* Highest priority value will be used.
  * Default parameters are priority 0
Index: surf/surf.c
===================================================================
--- surf.orig/surf.c
+++ surf/surf.c
@@ -133,6 +133,11 @@ typedef struct {
 } Button;
 
 typedef struct {
+	char *token;
+	char *uri;
+} SearchEngine;
+
+typedef struct {
 	const char *uri;
 	Parameter config[ParameterLast];
 	regex_t re;
@@ -220,6 +225,7 @@ static void webprocessterminated(WebKitW
                                  Client *c);
 static void closeview(WebKitWebView *v, Client *c);
 static void destroywin(GtkWidget* w, Client *c);
+static gchar *parseuri(const gchar *uri);
 
 /* Hotkeys */
 static void pasteuri(GtkClipboard *clipboard, const char *text, gpointer d);
@@ -581,7 +587,7 @@ loaduri(Client *c, const Arg *a)
 			url = g_strdup_printf("file://%s", path);
 			free(path);
 		} else {
-			url = g_strdup_printf("https://%s", uri);
+			url = parseuri(uri);
 		}
 		if (apath != uri)
 			free(apath);
@@ -1778,6 +1784,20 @@ destroywin(GtkWidget* w, Client *c)
 		gtk_main_quit();
 }
 
+gchar *
+parseuri(const gchar *uri)
+{
+	guint i;
+
+	for (i = 0; i < LENGTH(searchengines); i++) {
+		if (g_str_has_prefix(uri, searchengines[i].token))
+			return g_strdup_printf(searchengines[i].uri,
+					       uri + strlen(searchengines[i].token));
+	}
+
+	return g_strdup_printf("http://%s", uri);
+}
+
 void
 pasteuri(GtkClipboard *clipboard, const char *text, gpointer d)
 {
